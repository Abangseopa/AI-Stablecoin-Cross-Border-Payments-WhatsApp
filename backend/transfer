// supabase/functions/transfer/index.ts
// deno-lint-ignore-file no-explicit-any
import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
/**
 * POST /functions/v1/transfer
 * Body:
 * {
 *   amountUSD: string|number,         // e.g. "5.00"
 *   customer_id: string,              // Bridge customer id (on_behalf_of)
 *   bridge_wallet_id: string,         // source wallet id (VAâ€™s wallet)
 *   external_account_id: string,      // destination external account id
 *   developer_feeUSD?: string|number, // optional, default "0.00"
 * }
 *
 * Bridge will debit source: { payment_rail: "bridge_wallet", currency: "usdb" }
 * and credit destination:   { payment_rail: "ach",          currency: "usd"  }
 */ const BRIDGE_API_KEY = Deno.env.get("BRIDGE_API_KEY") ?? "";
const BRIDGE_BASE_URL = Deno.env.get("BRIDGE_BASE_URL") ?? "https://api.bridge.xyz";
function toMoney2(value, fallback = "0.00") {
  const n = Number(value);
  if (!Number.isFinite(n) || n <= 0) return fallback;
  return n.toFixed(2);
}
function bad(msg, code = 400) {
  return new Response(JSON.stringify({
    error: msg
  }), {
    status: code,
    headers: {
      "Content-Type": "application/json; charset=utf-8"
    }
  });
}
serve(async (req)=>{
  if (req.method !== "POST") {
    return new Response("Method Not Allowed", {
      status: 405
    });
  }
  if (!BRIDGE_API_KEY) {
    return bad("Server missing BRIDGE_API_KEY", 500);
  }
  let body = {};
  try {
    body = await req.json();
  } catch  {
    return bad("Invalid JSON body");
  }
  const amountUSD = toMoney2(body.amountUSD);
  const developerFeeUSD = toMoney2(body.developer_feeUSD ?? "0.00");
  const customer_id = String(body.customer_id ?? "");
  const bridge_wallet_id = String(body.bridge_wallet_id ?? "");
  const external_account_id = String(body.external_account_id ?? "");
  if (amountUSD === "0.00") return bad("amountUSD must be > 0");
  if (!customer_id) return bad("customer_id is required");
  if (!bridge_wallet_id) return bad("bridge_wallet_id is required");
  if (!external_account_id) return bad("external_account_id is required");
  const idem = crypto.randomUUID(); // unique idempotency key per transfer
  const payload = {
    amount: amountUSD,
    on_behalf_of: customer_id,
    developer_fee: developerFeeUSD,
    source: {
      payment_rail: "bridge_wallet",
      currency: "usdb",
      bridge_wallet_id
    },
    destination: {
      payment_rail: "ach",
      currency: "usd",
      external_account_id
    }
  };
  try {
    const r = await fetch(`${BRIDGE_BASE_URL}/v0/transfers`, {
      method: "POST",
      headers: {
        "Api-Key": BRIDGE_API_KEY,
        "Idempotency-Key": idem,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=>({}));
    if (!r.ok) {
      return new Response(JSON.stringify({
        ok: false,
        status: r.status,
        bridge_error: data
      }), {
        status: 502,
        headers: {
          "Content-Type": "application/json; charset=utf-8"
        }
      });
    }
    return new Response(JSON.stringify({
      ok: true,
      idempotency_key: idem,
      transfer: data
    }), {
      status: 200,
      headers: {
        "Content-Type": "application/json; charset=utf-8"
      }
    });
  } catch (err) {
    return new Response(JSON.stringify({
      ok: false,
      error: String(err)
    }), {
      status: 500,
      headers: {
        "Content-Type": "application/json; charset=utf-8"
      }
    });
  }
});

