// supabase/functions/stripe_webhook/index.ts
// deno-lint-ignore-file no-explicit-any
import { serve } from "https://deno.land/std@0.224.0/http/server.ts";
import Stripe from "https://esm.sh/stripe@14.24.0?target=deno&deno-std=0.224.0";
const STRIPE_SECRET_KEY = Deno.env.get("STRIPE_SECRET_KEY");
const STRIPE_WEBHOOK_SECRET = Deno.env.get("STRIPE_WEBHOOK_SECRET");
const stripe = new Stripe(STRIPE_SECRET_KEY, {
  apiVersion: "2025-05-28.basil"
});
serve(async (req)=>{
  // Simple health check so you can hit it from a browser
  if (req.method === "GET") return new Response("ok", {
    status: 200
  });
  const sig = req.headers.get("stripe-signature") ?? req.headers.get("Stripe-Signature") ?? "";
  // IMPORTANT: use the raw body for signature verification
  const rawBody = await req.text();
  let event;
  try {
    event = stripe.webhooks.constructEvent(rawBody, sig, STRIPE_WEBHOOK_SECRET);
  } catch (err) {
    return new Response(`Webhook signature verification failed: ${err.message}`, {
      status: 400
    });
  }
  // Handle the events you care about
  switch(event.type){
    case "payment_intent.processing":
    case "payment_intent.succeeded":
    case "payment_intent.payment_failed":
    case "charge.succeeded":
    case "charge.failed":
    case "checkout.session.completed":
      console.log("✅ Stripe event:", event.type, event.id);
      break;
    default:
      console.log("ℹ️ Ignoring:", event.type);
  }
  return new Response(JSON.stringify({
    received: true
  }), {
    headers: {
      "Content-Type": "application/json"
    }
  });
});

